/*!
* js-data-localstorage
* @version 3.0.0-alpha.5 - Homepage <https://github.com/js-data/js-data-localstorage>
* @author Jason Dobry <jason.dobry@gmail.com>
* @copyright (c) 2014-2016 Jason Dobry
* @license MIT <https://github.com/js-data/js-data-localstorage/blob/master/LICENSE>
*
* @overview localStorage adapter for js-data.
*/
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("js-data")):"function"==typeof define&&define.amd?define(["js-data"],e):"object"==typeof exports?exports.LocalStorageAdapter=e(require("js-data")):t.LocalStorageAdapter=e(t.JSData)}(this,function(t){return function(t){function e(r){if(n[r])return n[r].exports;var o=n[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){"use strict";function r(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function o(t){return null!=t&&""!==t}function a(t,e){return e||(e=""),t.filter(o).join(e)}function i(){for(var t=arguments.length,e=Array(t),n=0;t>n;n++)e[n]=arguments[n];var r=a(e,"/");return r.replace(/([^:\/]|^)\/{2,}/g,"$1/")}function u(t){var e={},n=[];return t.forEach(function(t){t in e||(n.push(t),e[t]=0)}),n}function f(t){U.push(t)}function c(){U.length&&!O&&(O=!0,U[0]())}function l(t){U.length?f(t):(f(t),c())}function d(t){return new Promise(t).then(function(t){return O=!1,U.shift(),setTimeout(c,0),t},function(t){return O=!1,U.shift(),setTimeout(c,0),j(t)})}function s(t){I(this,t||{}),I(this,S)}var h=n(1),p=n(2),v=h.Query,g=h.utils,y=g.addHiddenPropsToTarget,b=g.deepMixIn,A=g.extend,I=g.fillIn,m=g.forEachRelation,w=g.forOwn,x=g.fromJson,P=g.get,F=g.isArray,M=g.isUndefined,K=g.resolve,j=g.reject,D=g.set,E=g.toJson,U=[],O=!1,C=function(){for(var t=this,e=arguments.length,n=Array(e),r=0;e>r;r++)n[r]=arguments[r];var o=n[n.length-1];return t.dbg.apply(t,[o.op].concat(n)),K()},R=function(){for(var t=this,e=arguments.length,n=Array(e),r=0;e>r;r++)n[r]=arguments[r];var o=n[n.length-2];return t.dbg.apply(t,[o.op].concat(n)),K()},S={basePath:"",debug:!1,returnDeletedIds:!1,storage:localStorage};s.extend=A,y(s.prototype,{afterCreate:R,afterCreateMany:R,afterDestroy:R,afterDestroyAll:R,afterFind:R,afterFindAll:R,afterUpdate:R,afterUpdateAll:R,afterUpdateMany:R,beforeCreate:C,beforeCreateMany:C,beforeDestroy:C,beforeDestroyAll:C,beforeFind:C,beforeFindAll:C,beforeUpdate:C,beforeUpdateAll:C,beforeUpdateMany:C,_create:function(t,e,n){var r=this,o={},a=t.relationFields||[];w(e,function(t,e){-1===a.indexOf(e)&&(o[e]=t)});var i=P(o,t.idAttribute)||p();D(o,t.idAttribute,i);var u=r.getIdPath(t,n,i);return r.storage.setItem(u,E(o)),r.ensureId(i,t,n),x(r.storage.getItem(u))},create:function(t,e,n){var r=this;return e||(e={}),n||(n={}),d(function(o,a){l(function(){var i=void 0;return i=n.op="beforeCreate",K(r[i](t,e,n)).then(function(o){var a=M(o)?e:o;return a=r._create(t,a,n),i=n.op="afterCreate",r[i](t,e,n,a).then(function(t){return a=M(t)?a:t,n.raw?{data:a,created:1}:a})}).then(o,a)})})},createMany:function(t,e,n){var r=this;return e||(e={}),n||(n={}),d(function(o,a){l(function(){var i=void 0;return i=n.op="beforeCreateMany",K(r[i](t,e,n)).then(function(o){var a=M(o)?e:o;return a=a.map(function(e){return r._create(t,e,n)}),i=n.op="afterCreateMany",r[i](t,e,n,a).then(function(t){return a=M(t)?a:t,n.raw?{data:a,created:a.length}:a})}).then(o,a)})})},dbg:function(){for(var t=arguments.length,e=Array(t),n=0;t>n;n++)e[n]=arguments[n];this.log.apply(this,["debug"].concat(e))},destroy:function(t,e,n){var r=this;n||(n={});var o=M(n.returnDeletedIds)?r.returnDeletedIds:!!n.returnDeletedIds;return d(function(a,i){l(function(){var u=void 0;return u=n.op="beforeDestroy",K(r[u](t,e,n)).then(function(){u=n.op="destroy",r.dbg(u,e,n);var a=r.getIdPath(t,n,e),i=r.storage.getItem(a),f=0;return i&&(r.storage.removeItem(a),r.removeId(e,t,n),f++),u=n.op="afterDestroy",K(r[u](t,e,n,f&&o?e:void 0)).then(function(t){e=M(t)&&o?e:t;var a={data:e,deleted:f};return r.getRaw(n)?a:a.data})}).then(a,i)})})},destroyAll:function(t,e,n){var r=this;e||(e={}),n||(n={});var o=M(n.returnDeletedIds)?r.returnDeletedIds:!!n.returnDeletedIds;return d(function(a,i){l(function(){var u=void 0;return u=n.op="beforeDestroyAll",K(r[u](t,e,n)).then(function(){return u=n.op="destroyAll",r.dbg(u,e,n),r.findAll(t,e,{raw:!1})}).then(function(a){var i=t.idAttribute,f=a.map(function(t){return P(t,i)});return f.forEach(function(e){r.storage.removeItem(r.getIdPath(t,n,e))}),r.removeId(f,t,n),u=n.op="afterDestroyAll",r[u](t,e,n,o?f:void 0).then(function(t){f=M(t)&&o?f:t;var e={data:f,deleted:a.length};return r.getRaw(n)?e:e.data})}).then(a,i)})})},ensureId:function(t,e,n){var r=this.getIds(e,n);if(F(t)){if(!t.length)return;t.forEach(function(t){r[t]=1})}else r[t]=1;this.saveKeys(r,e,n)},find:function(t,e,n){var o=this,a=void 0,i=void 0;return n||(n={}),n.with||(n.with=[]),i=n.op="beforeFind",K(o[i](t,e,n)).then(function(){i=n.op="find",o.dbg(i,e,n);var f=o.getIdPath(t,n,e);if(a=o.storage.getItem(f),!a)return void(a=void 0);a=x(a);var c=[];return m(t,n,function(e,n){var i=e.getRelation(),f=void 0;if("hasOne"!==e.type&&"hasMany"!==e.type||!e.foreignKey)if("hasMany"===e.type&&e.localKeys){var l=[],d=P(a,e.localKeys)||[];d=F(d)?d:Object.keys(d),l=l.concat(d),f=o.findAll(i,{where:r({},i.idAttribute,{in:u(l).filter(function(t){return t})})},n).then(function(t){return D(a,e.localField,t),t})}else"hasMany"===e.type&&e.foreignKeys?f=o.findAll(i,{where:r({},e.foreignKeys,{contains:P(a,t.idAttribute)})},n).then(function(t){return D(a,e.localField,t),t}):"belongsTo"===e.type&&(f=o.find(i,P(a,e.foreignKey),n).then(function(t){return D(a,e.localField,t),t}));else f=o.findAll(i,r({},e.foreignKey,P(a,t.idAttribute)),n).then(function(t){return"hasOne"===e.type&&t.length?D(a,e.localField,t[0]):D(a,e.localField,t),t});f&&c.push(f)}),Promise.all(c)}).then(function(){return i=n.op="afterFind",K(o[i](t,e,n,a)).then(function(t){return a=M(t)?a:t,n.raw?{data:a,found:a?1:0}:a})})},findAll:function(t,e,n){var o=this,a=[],i=void 0;return n||(n={}),n.with||(n.with=[]),i=n.op="beforeFindAll",K(o[i](t,e,n)).then(function(){i=n.op="findAll",o.dbg(i,e,n);var f=o.getIds(t,n);w(f,function(e,r){var i=o.storage.getItem(o.getIdPath(t,n,r));i&&a.push(x(i))});var c=t.idAttribute,l=new v({index:{getAll:function(){return a}}});a=l.filter(e).run();var d=[];return m(t,n,function(t,e){var n=t.getRelation(),i=void 0;"hasOne"!==t.type&&"hasMany"!==t.type||!t.foreignKey?"hasMany"===t.type&&t.localKeys?!function(){var f=[];a.forEach(function(e){var n=P(e,t.localKeys)||[];n=Array.isArray(n)?n:Object.keys(n),f=f.concat(n)}),i=o.findAll(n,{where:r({},n.idAttribute,{in:u(f).filter(function(t){return t})})},e).then(function(e){return a.forEach(function(r){var o=[],a=P(r,t.localKeys)||[];a=Array.isArray(a)?a:Object.keys(a),e.forEach(function(t){a&&-1!==a.indexOf(t[n.idAttribute])&&o.push(t)}),D(r,t.localField,o)}),e})}():"belongsTo"===t.type&&(i=o.findAll(n,{where:r({},n.idAttribute,{in:a.map(function(e){return P(e,t.foreignKey)}).filter(function(t){return t})})},e).then(function(e){return a.forEach(function(r){e.forEach(function(e){e[n.idAttribute]===P(r,t.foreignKey)&&D(r,t.localField,e)})}),e})):i=o.findAll(n,{where:r({},t.foreignKey,{in:a.map(function(t){return P(t,c)}).filter(function(t){return t})})},e).then(function(e){return a.forEach(function(n){var r=[];e.forEach(function(e){P(e,t.foreignKey)===P(n,c)&&r.push(e)}),"hasOne"===t.type&&r.length?D(n,t.localField,r[0]):D(n,t.localField,r)}),e}),i&&d.push(i)}),Promise.all(d)}).then(function(){return i=n.op="afterFindAll",K(o[i](t,e,n,a)).then(function(t){return a=M(t)?a:t,n.raw?{data:a,found:a.length}:a})})},getPath:function(t,e){return e=e||{},i(void 0===e.basePath?void 0===t.basePath?this.basePath:t.basePath:e.basePath,t.name)},getIdPath:function(t,e,n){return e=e||{},i(e.basePath||this.basePath||t.basePath,t.endpoint,n)},getIds:function(t,e){var n=void 0,r=this.getPath(t,e),o=this.storage.getItem(r);return n=o?x(o):{}},getRaw:function(t){return t||(t={}),!!(M(t.raw)?this.raw:t.raw)},log:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;e>r;r++)n[r-1]=arguments[r];if(t&&!n.length&&(n.push(t),t="debug"),"debug"!==t||this.debug){var o=t.toUpperCase()+": (LocalStorageAdapter)";if(console[t]){var a;(a=console)[t].apply(a,[o].concat(n))}else{var i;(i=console).log.apply(i,[o].concat(n))}}},removeId:function(t,e,n){var r=this.getIds(e,n);if(F(t)){if(!t.length)return;t.forEach(function(t){delete r[t]})}else delete r[t];this.saveKeys(r,e,n)},saveKeys:function(t,e,n){t=t||{};var r=this.getPath(e,n);Object.keys(t).length?this.storage.setItem(r,E(t)):this.storage.removeItem(r)},update:function(t,e,n,r){var o=this;return n||(n={}),r||(r={}),d(function(a,i){l(function(){var u=void 0;return u=r.op="beforeUpdate",K(o[u](t,e,n,r)).then(function(a){n=M(a)?n:a;var i=o.getIdPath(t,r,e),f=o.storage.getItem(i);f=f?x(f):void 0;var c=0;if(!f)throw new Error("Not Found");return b(f,n),o.storage.setItem(i,E(f)),c++,u=r.op="afterUpdate",K(o[u](t,e,n,r,f)).then(function(t){return f=M(t)?f:t,r.raw?{data:f,updated:c}:f})}).then(a,i)})})},updateAll:function(t,e,n,r){var o=this;return e||(e={}),n||(n={}),r||(r={}),d(function(a,i){l(function(){var u=void 0;return u=r.op="beforeUpdateAll",K(o[u](t,e,n,r)).then(function(a){return e=M(a)?e:a,u=r.op="updateAll",o.dbg(u,n,r),o.findAll(t,n,r)}).then(function(a){var i=t.idAttribute,f=0;return a.forEach(function(n){n||(n={});var a=P(n,i),u=o.getIdPath(t,r,a);b(n,e),o.storage.setItem(u,E(n)),f++}),u=r.op="afterUpdateAll",o[u](t,e,n,r,a).then(function(t){return a=M(t)?a:t,r.raw?{data:a,updated:f}:a})}).then(a,i)})})},updateMany:function(t,e,n){var r=this;return e||(e=[]),n||(n={}),d(function(o,a){l(function(){var i=void 0,u=[];return i=n.op="beforeUpdateMany",K(r[i](t,e,n)).then(function(o){e=M(o)?e:o,i=n.op="updateMany",r.dbg(i,e,n);var a=t.idAttribute;return e.forEach(function(e){if(e){var o=P(e,a);if(!M(o)){var i=r.getIdPath(t,n,o),f=r.storage.getItem(i),c=f?x(f):void 0;c&&(b(c,e),r.storage.setItem(i,E(c)),u.push(c))}}}),i=n.op="afterUpdateMany",r[i](t,e,n,u).then(function(t){return e=M(t)?u:t,n.raw?{data:e,updated:u.length}:e})}).then(o,a)})})}}),s.version={full:"<%= pkg.version %>",major:parseInt("<%= major %>",10),minor:parseInt("<%= minor %>",10),patch:parseInt("<%= patch %>",10),alpha:"<%= alpha %>",beta:"<%= beta %>"},t.exports=s},function(e,n){e.exports=t},function(t,e,n){function r(){return o(8)+"-"+o(4)+"-4"+o(3)+"-"+a(8,9,"a","b")+o(3)+"-"+o(12)}var o=n(3),a=n(4);t.exports=r},function(t,e,n){function r(t){t=t&&t>0?t:6;for(var e="";t--;)e+=o(a);return e}var o=n(4),a="0123456789abcdef".split("");t.exports=r},function(t,e,n){function r(t){var e=1===arguments.length&&a(t)?t:arguments;return e[o(0,e.length-1)]}var o=n(5),a=n(10);t.exports=r},function(t,e,n){function r(t,e){return t=null==t?o:~~t,e=null==e?a:~~e,Math.round(i(t-.5,e+.499999999999))}var o=n(6),a=n(7),i=n(8);t.exports=r},function(t,e){t.exports=-2147483648},function(t,e){t.exports=2147483647},function(t,e,n){function r(t,e){return t=null==t?a:t,e=null==e?i:e,t+(e-t)*o()}var o=n(9),a=n(6),i=n(7);t.exports=r},function(t,e){function n(){return n.get()}n.get=Math.random,t.exports=n},function(t,e,n){var r=n(11),o=Array.isArray||function(t){return r(t,"Array")};t.exports=o},function(t,e,n){function r(t,e){return o(t)===e}var o=n(12);t.exports=r},function(t,e){function n(t){return null===t?"Null":t===r?"Undefined":o.exec(a.call(t))[1]}var r,o=/^\[object (.*)\]$/,a=Object.prototype.toString;t.exports=n}])});
//# sourceMappingURL=dist/js-data-localstorage.min.map